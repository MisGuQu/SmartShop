<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartShop | Chi tiết đơn hàng</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .order-info__item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .order-info__label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.875rem;
        }
        .order-info__value {
            font-weight: 600;
            color: #0f172a;
        }
        .order-form__group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .order-form__select {
            width: 100%;
            padding: 0.55rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #fff;
        }
        .order-table__price {
            font-weight: 600;
            color: #10b981;
        }
        .order-summary__row {
            display: flex;
            justify-content: space-between;
            color: #64748b;
        }
    </style>
</head>
<body>
<header class="admin-header">
    <div class="admin-header__title">
        <a class="admin-header__logo" href="/">SmartShop</a>
        <span class="admin-header__subtitle">Bảng điều khiển quản trị</span>
    </div>
    <nav class="admin-header__nav">
        <a class="admin-header__link" href="/admin/dashboard">Dashboard</a>
        <a class="admin-header__link" href="/admin/products">Sản phẩm</a>
        <a class="admin-header__link" href="/admin/users">Người dùng</a>
        <a class="admin-header__link admin-header__link--active" href="/admin/orders">Đơn hàng</a>
    </nav>
</header>

<main class="admin-main">
    <section class="admin-card admin-card--stack">
        <div class="admin-card__header">
            <div>
                <h1 class="admin-card__title">Chi tiết đơn hàng</h1>
                <p class="admin-card__subtitle" th:text="'Mã đơn hàng: ' + ${order.orderNumber}"></p>
            </div>
            <div class="admin-card__actions">
                <a class="admin-chip" href="/admin/orders">← Quay lại danh sách</a>
            </div>
        </div>

        <div th:if="${successMessage}" class="alert alert--success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert--error" th:text="${errorMessage}"></div>
    </section>

    <div th:if="${order}" class="order-details">
        <!-- Thông tin đơn hàng -->
        <section class="admin-card">
            <div class="admin-card__header">
                <div>
                    <h2 class="admin-card__title">Thông tin đơn hàng</h2>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="order-info__item">
                    <span class="order-info__label">Mã đơn hàng</span>
                    <span class="order-info__value" th:text="${order.orderNumber}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Ngày đặt hàng</span>
                    <span th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm') : '-'}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Trạng thái</span>
                    <span class="status"
                          th:classappend="${order.status.name() == 'PENDING'} ? 'status--warning' :
                                          (${order.status.name() == 'PROCESSING' || order.status.name() == 'SHIPPING'} ? 'status--info' :
                                          (${order.status.name() == 'DELIVERED'} ? 'status--active' :
                                          (${order.status.name() == 'CANCELLED'} ? 'status--inactive' : 'status--secondary')))}"
                          th:text="${order.status.name()}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Phương thức thanh toán</span>
                    <span th:text="${order.paymentMethod.name()}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Trạng thái thanh toán</span>
                    <span class="status"
                          th:classappend="${order.paymentStatus.name() == 'PAID'} ? 'status--active' : 'status--warning'"
                          th:text="${order.paymentStatus.name()}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Tổng giá trị</span>
                    <span class="order-info__value" th:text="${#numbers.formatDecimal(order.totalAmount, 1, 'POINT', 0, 'COMMA')} + ' ₫'"></span>
                </div>
            </div>
        </section>

        <!-- Thông tin khách hàng -->
        <section class="admin-card">
            <div class="admin-card__header">
                <div>
                    <h2 class="admin-card__title">Thông tin khách hàng</h2>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="order-info__item">
                    <span class="order-info__label">Họ tên</span>
                    <span th:text="${order.user != null ? order.user.fullName : 'Khách lẻ'}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Email</span>
                    <span th:text="${order.user != null && order.user.email != null ? order.user.email : '-'}"></span>
                </div>
                <div class="order-info__item">
                    <span class="order-info__label">Số điện thoại</span>
                    <span th:text="${order.user != null && order.user.phone != null ? order.user.phone : '-'}"></span>
                </div>
            </div>
        </section>
    </div>

    <!-- Danh sách sản phẩm -->
    <section class="admin-card">
        <div class="admin-card__header">
            <div>
                <h2 class="admin-card__title">Danh sách sản phẩm</h2>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="table">
                <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Biến thể</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${order.items}">
                    <td>
                        <div class="table__primary">
                            <span th:text="${item.product != null ? item.product.name : 'Sản phẩm'}"></span>
                        </div>
                    </td>
                    <td th:text="${item.variant != null ? item.variant.variantName : '-'}"></td>
                    <td th:text="${item.quantity}"></td>
                    <td>
                        <span th:text="${#numbers.formatDecimal(item.price, 1, 'POINT', 0, 'COMMA')} + ' ₫'"></span>
                    </td>
                    <td>
                        <span class="order-table__price"
                              th:text="${#numbers.formatDecimal(item.price * item.quantity, 1, 'POINT', 0, 'COMMA')} + ' ₫'"></span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Tổng tiền và Cập nhật trạng thái -->
    <div class="order-details">
        <!-- Tổng tiền -->
        <section class="admin-card">
            <div class="admin-card__header">
                <div>
                    <h2 class="admin-card__title">Tổng tiền</h2>
                </div>
            </div>
            <div class="order-info__item" style="margin-top: 0.5rem;">
                <span class="order-info__label">Tổng thanh toán</span>
                <span class="order-info__value" style="color: #10b981;"
                      th:text="${#numbers.formatDecimal(order.totalAmount, 1, 'POINT', 0, 'COMMA')} + ' ₫'"></span>
            </div>
            <div class="order-info__item">
                <span class="order-info__label">Địa chỉ giao hàng</span>
                <span th:text="${order.shippingAddress != null ? order.shippingAddress : 'Chưa cập nhật'}"></span>
            </div>
        </section>

        <!-- Cập nhật trạng thái -->
        <section class="admin-card">
            <div class="admin-card__header">
                <div>
                    <h2 class="admin-card__title">Cập nhật trạng thái</h2>
                </div>
            </div>
            <form th:action="@{/admin/orders/{id}/status(id=${order.id})}" method="post" class="order-form__group">
                <div class="order-form__group">
                    <label class="order-info__label">Trạng thái mới</label>
                    <select name="status" class="order-form__select">
                        <option value="">-- Chọn trạng thái --</option>
                        <option th:if="${order.status.name() == 'PENDING'}" value="PROCESSING">PROCESSING</option>
                        <option th:if="${order.status.name() == 'PENDING'}" value="CANCELLED">CANCELLED</option>
                        <option th:if="${order.status.name() == 'PROCESSING'}" value="SHIPPING">SHIPPING</option>
                        <option th:if="${order.status.name() == 'PROCESSING'}" value="CANCELLED">CANCELLED</option>
                        <option th:if="${order.status.name() == 'SHIPPING'}" value="DELIVERED">DELIVERED</option>
                        <option th:if="${order.status.name() == 'CONFIRMED'}" value="PROCESSING">PROCESSING</option>
                    </select>
                    <p class="order-info__label" style="font-weight: 400;">
                        <span th:if="${order.status.name() == 'PENDING'}">Luồng hợp lệ: PENDING → PROCESSING hoặc CANCELLED</span>
                        <span th:if="${order.status.name() == 'PROCESSING'}">Luồng hợp lệ: PROCESSING → SHIPPING hoặc CANCELLED</span>
                        <span th:if="${order.status.name() == 'SHIPPING'}">Luồng hợp lệ: SHIPPING → DELIVERED</span>
                        <span th:if="${order.status.name() == 'CONFIRMED'}">Luồng hợp lệ: CONFIRMED → PROCESSING</span>
                        <span th:if="${order.status.name() == 'DELIVERED' || order.status.name() == 'CANCELLED' || order.status.name() == 'REFUNDED'}">
                            Đơn hàng này đã kết thúc, không thể thay đổi trạng thái
                        </span>
                    </p>
                </div>
                <button type="submit"
                        class="button button--primary"
                        th:disabled="${order.status.name() == 'DELIVERED' || order.status.name() == 'CANCELLED' || order.status.name() == 'REFUNDED'}">
                    Cập nhật trạng thái
                </button>
            </form>
        </section>
    </div>
</main>

</body>
</html>

